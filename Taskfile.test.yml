# https://taskfile.dev
version: "3"

tasks:
  test:config:update:
    deps:
      - task: config:lint
    cmd: yq -i e '.cluster_oidc_issuer_url |= "{{.OIDC_ISSUER}}"' "{{.CONFIG_FILE}}"

  test:aks:create:
    deps:
      - task: azure:init
    env:
      KUBECONFIG:
        sh: echo ${HOME}/.kube/config
    cmds:
      - >-
        az aks create --sku base --enable-oidc-issuer --enable-workload-identity --output none \
          --name "{{.CLUSTER_NAME}}" --kubernetes-version ${AKS_VERSION:-1.33} --node-vm-size ${AKS_NODE_SIZE:-standard_d4alds_v6}
      - az aks get-credentials --name "{{.CLUSTER_NAME}}" --overwrite-existing {{.AZ_CLI_OPTS}}
      - task: test:config:update
        vars:
          OIDC_ISSUER:
            sh: az aks show --name "{{.CLUSTER_NAME}}" --query "oidcIssuerProfile.issuerUrl" -o tsv --only-show-errors

  test:aks:destroy:
    deps:
      - task: azure:init
    cmds:
      - az aks delete --name "{{.CLUSTER_NAME}}" --yes {{.CLI_ARGS}}
